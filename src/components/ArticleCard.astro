---
import { getLangFromUrl, useTranslatedPath, type Lang } from '@/i18n/utils';
import { getCategoryInfo } from '@/utils/get-categories';
import { render, type CollectionEntry } from 'astro:content';
import coverPlaceholder from '@/assets/astro.svg';
import { Image } from "astro:assets";
import { DEFAULT_COVER_PATH, getPostOgImagePath, getSlugById, sanitizeSlug } from '@/utils/getPosts';

interface Props {
  post: CollectionEntry<'blog'>
}

const { post } = Astro.props;

const { cover, title, description, date, category, tags } = post.data;
const { remarkPluginFrontmatter } = await render(post);

const lang = getLangFromUrl(Astro.url);

const translatePath = useTranslatedPath(lang)

const postSlug = getSlugById(post.id)
const cardTransitionName = `post-card-${lang}-${sanitizeSlug(postSlug)}`
const titleTransitionName = `post-title-${lang}-${sanitizeSlug(postSlug)}`
const timeTransitionName = `post-time-${lang}-${sanitizeSlug(postSlug)}`
const categoryTransitionName = `post-category-${lang}-${sanitizeSlug(postSlug)}`
const coverTransitionName = `post-cover-${lang}-${sanitizeSlug(postSlug)}`

const formattedDate = date.toLocaleDateString(lang, {dateStyle: 'medium'});

const coverImage = post.data.cover ?? DEFAULT_COVER_PATH

const categoryInfo = getCategoryInfo(category);

const displayExcerpt = description || remarkPluginFrontmatter.excerpt || ''; // Fallback chain
---

<article class="group relative flex flex-col md:flex-row overflow-hidden rounded-xl" transition:name={cardTransitionName}>
  <!-- Cover Image -->
  <div class="relative w-full md:w-1/3 overflow-hidden shrink-0">
    <Image
      src={coverImage} 
      alt={title}
      width={360}
      height={225}
      class="w-full h-full rounded-t-xl sm:rounded-l-xl sm:rounded-t-none object-cover transition-transform duration-300 ease-out group-hover:scale-103"
      transition:name={coverTransitionName}
    />
  </div>

  <div class="pointer-events-none absolute rounded-xl inset-0 ring-1 ring-inset ring-black/5 dark:ring-white/10 group-hover:ring-black/10 dark:group-hover:ring-white/15" />
  
  <!-- Content -->
  <div class="flex flex-1 flex-col p-4 md:p-6 tracking-wide">
    <div class="flex mb-2 text-xs text-muted-foreground overflow-hidden whitespace-nowrap">
      <time datetime={date.toISOString()} transition:name={timeTransitionName}>{formattedDate}</time>
      {categoryInfo && (
        <>
          <span class="mx-2">â€¢</span>
          <a href={categoryInfo.href} class="z-10 hover:text-primary" transition:name={categoryTransitionName}>{categoryInfo.name}</a>
        </>
      )}
    </div>
    
    <h2 class="text-xl font-semibold line-clamp-2">
      <a href={translatePath(`/posts/${postSlug}`)} class="before:absolute before:inset-0">
        <span
          class="transition-opacity duration-300"
          transition:name={titleTransitionName}
        >
          {title}
        </span>
      </a>
    </h2>
    <p class="mt-2 text-sm text-muted-foreground line-clamp-3">
      {displayExcerpt}
    </p>
  </div>
</article>
