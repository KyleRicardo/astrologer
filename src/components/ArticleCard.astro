---
import { getLangFromUrl, useTranslatedPath } from '@/i18n/utils'
import { getCategoryInfo } from '@/utils/get-categories'
import { render, type CollectionEntry } from 'astro:content'
import { Image } from 'astro:assets'
import { DEFAULT_COVER_PATH, getSlugById, sanitizeSlug } from '@/utils/getPosts'

interface Props {
  post: CollectionEntry<'blog'>
}

const { post } = Astro.props

const { title, description, date, category } = post.data
const { remarkPluginFrontmatter } = await render(post)

const lang = getLangFromUrl(Astro.url)

const translatePath = useTranslatedPath(lang)

const postSlug = getSlugById(post.id)
const cardTransitionName = `post-card-${lang}-${sanitizeSlug(postSlug)}`
const titleTransitionName = `post-title-${lang}-${sanitizeSlug(postSlug)}`
const timeTransitionName = `post-time-${lang}-${sanitizeSlug(postSlug)}`
const categoryTransitionName = `post-category-${lang}-${sanitizeSlug(postSlug)}`
const coverTransitionName = `post-cover-${lang}-${sanitizeSlug(postSlug)}`

const formattedDate = date.toLocaleDateString(lang, { dateStyle: 'medium' })

const coverImage = post.data.cover ?? DEFAULT_COVER_PATH

const categoryInfo = getCategoryInfo(category)

const displayExcerpt = description || remarkPluginFrontmatter.excerpt || '' // Fallback chain
---

<article
  class="group relative flex flex-col overflow-hidden rounded-xl md:flex-row"
  transition:name={cardTransitionName}
>
  <!-- Cover Image -->
  <div class="relative w-full shrink-0 overflow-hidden md:w-1/3">
    <Image
      src={coverImage}
      alt={title}
      width={360}
      height={225}
      class="h-full w-full rounded-t-xl object-cover transition-transform duration-300 ease-out group-hover:scale-103 sm:rounded-t-none sm:rounded-l-xl"
      transition:name={coverTransitionName}
    />
  </div>

  <div class="pointer-events-none absolute inset-0 rounded-xl ring-1 ring-black/5 ring-inset group-hover:ring-black/10 dark:ring-white/10 dark:group-hover:ring-white/15">
  </div>

  <!-- Content -->
  <div class="flex flex-1 flex-col p-4 tracking-wide md:p-6">
    <div class="text-muted-foreground mb-2 flex overflow-hidden text-xs whitespace-nowrap">
      <time
        datetime={date.toISOString()}
        transition:name={timeTransitionName}
      >
        {formattedDate}
      </time>
      {categoryInfo && (
        <>
          <span class="mx-2">â€¢</span>
          <a
            href={categoryInfo.href}
            class="hover:text-primary z-10"
            transition:name={categoryTransitionName}
          >
            {categoryInfo.name}
          </a>
        </>
      )}
    </div>

    <h2 class="line-clamp-2 text-xl font-semibold">
      <a
        href={translatePath(`/posts/${postSlug}`)}
        class="before:absolute before:inset-0"
      >
        <span
          class="transition-opacity duration-300"
          transition:name={titleTransitionName}
        >
          {title}
        </span>
      </a>
    </h2>
    <p class="text-muted-foreground mt-2 line-clamp-3 text-sm">
      {displayExcerpt}
    </p>
  </div>
</article>
