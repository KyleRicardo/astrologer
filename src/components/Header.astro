---
import {
  getLangFromUrl,
  useTranslations,
  useTranslatedPath,
} from '@/i18n/utils'
import NavIcon from './NavIcon.astro'
import { ModeToggle } from './ModeToggle'
import LangSwitcher from './LangSwitcher.astro'
import { getSiteConfig } from '@/site.config'

const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
const translatePath = useTranslatedPath(lang)
const siteConfig = getSiteConfig(lang)

interface Props {
  showProgressBar?: boolean
}

const { showProgressBar = false } = Astro.props
---

<header class="bg-background/95 supports-backdrop-filter:bg-background/60 sticky top-0 z-50 w-full border-b border-dashed border-black/10 backdrop-blur dark:border-white/15">
  <div class="container mx-auto flex h-14 max-w-[1400px] items-center gap-2 px-4 md:gap-4">
    <div class="globalnav-menutrigger absolute top-0 left-0 z-3 md:hidden">
      <button
        class="relative flex h-14 w-14 items-center justify-center"
        id="globalnav-menutrigger-button"
        aria-controls="globalnav-list"
        aria-label="Menu"
        data-topnav-menu-label-open="Menu"
        data-topnav-menu-label-close="Close"
        data-topnav-flyout-trigger-compact="menu"
        class="globalnav-menutrigger-button"
      >
        <svg width="18" height="18" viewBox="0 0 18 18">
          <polyline
            id="globalnav-menutrigger-bread-bottom"
            fill="none"
            stroke="currentColor"
            stroke-width="1.2"
            stroke-linecap="round"
            stroke-linejoin="round"
            points="2 12, 16 12"
            class="globalnav-menutrigger-bread globalnav-menutrigger-bread-bottom"
          >
            <animate
              id="globalnav-anim-menutrigger-bread-bottom-open"
              attributeName="points"
              keyTimes="0;0.5;1"
              dur="0.24s"
              begin="indefinite"
              fill="freeze"
              calcMode="spline"
              keySplines="0.42, 0, 1, 1;0, 0, 0.58, 1"
              values=" 2 12, 16 12; 2 9, 16 9; 3.5 15, 15 3.5"
            >
            </animate>
            <animate
              id="globalnav-anim-menutrigger-bread-bottom-close"
              attributeName="points"
              keyTimes="0;0.5;1"
              dur="0.24s"
              begin="indefinite"
              fill="freeze"
              calcMode="spline"
              keySplines="0.42, 0, 1, 1;0, 0, 0.58, 1"
              values=" 3.5 15, 15 3.5; 2 9, 16 9; 2 12, 16 12"
            >
            </animate>
          </polyline>
          <polyline
            id="globalnav-menutrigger-bread-top"
            fill="none"
            stroke="currentColor"
            stroke-width="1.2"
            stroke-linecap="round"
            stroke-linejoin="round"
            points="2 5, 16 5"
            class="globalnav-menutrigger-bread globalnav-menutrigger-bread-top"
          >
            <animate
              id="globalnav-anim-menutrigger-bread-top-open"
              attributeName="points"
              keyTimes="0;0.5;1"
              dur="0.24s"
              begin="indefinite"
              fill="freeze"
              calcMode="spline"
              keySplines="0.42, 0, 1, 1;0, 0, 0.58, 1"
              values=" 2 5, 16 5; 2 9, 16 9; 3.5 3.5, 15 15"
            >
            </animate>
            <animate
              id="globalnav-anim-menutrigger-bread-top-close"
              attributeName="points"
              keyTimes="0;0.5;1"
              dur="0.24s"
              begin="indefinite"
              fill="freeze"
              calcMode="spline"
              keySplines="0.42, 0, 1, 1;0, 0, 0.58, 1"
              values=" 3.5 3.5, 15 15; 2 9, 16 9; 2 5, 16 5"
            >
            </animate>
          </polyline>
        </svg>
      </button>
    </div>
    <div
      id="mobile-menu"
      class="bg-background absolute top-0 left-0 z-2 w-full pt-14 transition-all duration-640 data-[state=closed]:invisible data-[state=closed]:h-0 data-[state=closed]:opacity-0 data-[state=open]:visible data-[state=open]:h-screen data-[state=open]:opacity-100 md:hidden"
      data-state="closed"
    >
      <ul class="flex flex-col gap-4 px-12 text-3xl font-semibold *:transition-all *:delay-320 *:duration-640">
        <li>
          <a href={translatePath('/posts')}>{t('nav.blog')}</a>
        </li>
        {siteConfig.enableProjectsShowcase && (
          <li>
            <a href={translatePath('/projects')}>{t('nav.projects')}</a>
          </li>
        )}
        {siteConfig.enableAboutMe && (
          <li>
            <a href={translatePath('/about')}>{t('nav.about')}</a>
          </li>
        )}
        {siteConfig.socials.map(social => (
          <li>
            <a
              href={social.url}
              rel="noopener noreferrer"
              target="_blank"
            >{social.name}</a>
          </li>
        ))}
        <li>
          <a
            href={translatePath('/rss.xml')}
            rel="noopener noreferrer"
            target="_blank"
          >RSS Feed</a>
        </li>
      </ul>
    </div>
    <div class="mr-4 flex">
      <a class="mr-4 flex items-center gap-2 lg:mr-6" href={translatePath('/')}>
        <span
          class="ml-8 inline-block font-bold md:ml-0"
        >{siteConfig.title}</span>
      </a>
      <nav class="hidden items-center gap-4 text-sm md:flex lg:gap-6">
        <a
          class="hover:text-foreground/80 text-foreground/80 transition-colors"
          href={translatePath('/posts')}
        >{t('nav.blog')}</a>
        {siteConfig.enableProjectsShowcase && (
          <a
            class="hover:text-foreground/80 text-foreground/80 transition-colors"
            href={translatePath('/projects')}
          >{t('nav.projects')}</a>
        )}
        {siteConfig.enableAboutMe && (
          <a
            class="hover:text-foreground/80 text-foreground/80 transition-colors"
            href={translatePath('/about')}
          >{t('nav.about')}</a>
        )}
      </nav>
    </div>
    <div class="ml-auto flex items-center md:flex-1 md:justify-end">
      <div class="hidden! w-full flex-1 md:flex md:w-auto md:flex-none">
        <button class="focus-visible:ring-ring border-input hover:bg-accent hover:text-accent-foreground bg-muted/50 text-muted-foreground relative inline-flex h-8 w-full items-center justify-start gap-2 rounded-[0.5rem] border px-4 py-2 text-sm font-normal whitespace-nowrap shadow-none transition-colors focus-visible:ring-1 focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 sm:pr-12 md:w-40 lg:w-56 xl:w-64 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0">
          <span class="hidden lg:inline-flex">Search...</span>
          <kbd
            class="bg-muted pointer-events-none absolute top-[0.3rem] right-[0.3rem] hidden h-5 items-center gap-1 rounded border px-1.5 font-mono text-[10px] font-medium opacity-100 select-none sm:flex"
          >
            <span class="text-xs">âŒ˜</span>K
          </kbd>
        </button>
      </div>
      <div aria-label="" class="ml-2 hidden md:inline-block">
        <ul class="flex items-center gap-1">
          {siteConfig.socials.filter(social => social.showOnHeader).map(
            social => (
              <li>
                <NavIcon
                  name={social.name}
                  href={social.url}
                  icon={social.icon}
                  external={true}
                />
              </li>
            ),
          )}
          <li>
            <NavIcon
              name="RSS Feed"
              href={translatePath('/rss.xml')}
              icon="ri:rss-fill"
              external={true}
            />
          </li>
        </ul>
      </div>
      <div aria-label="display options" class="ml-1 flex items-center">
        <LangSwitcher />
        <ModeToggle client:load />
      </div>
    </div>
  </div>
  {showProgressBar && (
    <div
      id="reading-progress"
      class="bg-primary absolute -bottom-px left-0 z-50 h-0.5 w-full origin-left transition-transform duration-100 ease-out will-change-transform"
      style="transform: scaleX(0)"
    >
    </div>
  )}
</header>

<script>
// State tracking
let menuOpen = false
let previouslyWideScreen = window.innerWidth >= 768 // md breakpoint in Tailwind

// Toggle menu function
function toggleMenu() {
  console.log('toggleMenu', menuOpen)
  if (menuOpen) {
    // Close menu
    document.getElementById('globalnav-anim-menutrigger-bread-top-close')
      ?.beginElement()
    document.getElementById('globalnav-anim-menutrigger-bread-bottom-close')
      ?.beginElement()
    document.getElementById('mobile-menu')?.setAttribute('data-state', 'closed')
  } else {
    // Open menu
    document.getElementById('globalnav-anim-menutrigger-bread-top-open')
      ?.beginElement()
    document.getElementById('globalnav-anim-menutrigger-bread-bottom-open')
      ?.beginElement()
    document.getElementById('mobile-menu')?.setAttribute('data-state', 'open')
  }
  menuOpen = !menuOpen
}

// Handle resize events
function handleResize() {
  const isWideScreen = window.innerWidth >= 768 // md breakpoint in Tailwind

  // If transitioning from small to large screen, close the menu
  if (!previouslyWideScreen && isWideScreen) {
    console.log('small -> wide')
    if (menuOpen) {
      document.getElementById('globalnav-anim-menutrigger-bread-top-close')
        ?.beginElement()
      document.getElementById('globalnav-anim-menutrigger-bread-bottom-close')
        ?.beginElement()
      document.getElementById('mobile-menu')?.setAttribute(
        'data-state',
        'closed',
      )
      menuOpen = false
    }
  }

  // If going from wide to small, ensure menu is closed
  if (previouslyWideScreen && !isWideScreen) {
    // Reset menu state when transitioning back to mobile
    console.log('wide -> small')
    if (menuOpen) {
      document.getElementById('globalnav-anim-menutrigger-bread-top-close')
        ?.beginElement()
      document.getElementById('globalnav-anim-menutrigger-bread-bottom-close')
        ?.beginElement()
      document.getElementById('mobile-menu')?.setAttribute(
        'data-state',
        'closed',
      )
      menuOpen = false
    }
  }

  previouslyWideScreen = isWideScreen
}

// Reading Progress Bar Logic
function initProgressBar() {
  const progressBar = document.getElementById('reading-progress')
  if (!progressBar) return

  function updateProgress() {
    if (!progressBar) return
    const scrollTop = window.scrollY
    const docHeight = document.documentElement.scrollHeight - window.innerHeight
    const scrollPercent = docHeight > 0
      ? Math.min(Math.max(scrollTop / docHeight, 0), 1)
      : 0
    progressBar.style.transform = `scaleX(${scrollPercent})`
  }

  // Initial update
  updateProgress()

  // Update on scroll
  window.addEventListener('scroll', updateProgress, { passive: true })

  // Cleanup on unmount (Astro handles this mostly via page-load, but good practice)
  // For now we just add listener, subsequent page loads might accumulate if not careful?
  // Actually astro:page-load is triggered on every navigation.
  // Ideally we should remove the old listener, but since we are replacing the document body or part of it, it might be fine.
  // However, window event listeners persist.
  // Let's store the reference to remove it later if needed, OR just checking if element exists inside the handler is enough
  // but `updateProgress` closes over `progressBar`, so we need to be careful.
  // A simpler way for View Transitions is to add the listener and remove it on `astro:before-swap` or similar?
  // Or just make sure we don't duplicate logic.
  // The easiest way with `astro:page-load` is often sufficient if we don't worry about minor leaks, OR we clean up.

  // Let's try to be clean.
  const cleanUp = () => {
    window.removeEventListener('scroll', updateProgress)
  }

  document.addEventListener('astro:before-swap', cleanUp, { once: true })
}

// Add event listeners
document.addEventListener('astro:page-load', () => {
  document.getElementById('globalnav-menutrigger-button')?.addEventListener(
    'click',
    toggleMenu,
  )
  window.addEventListener('resize', handleResize)
  document.getElementById('mobile-menu')?.setAttribute('data-state', 'closed')
  menuOpen = false

  initProgressBar()
})
</script>
